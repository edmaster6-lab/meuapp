<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Transporte Pro">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <title>Transporte Pro</title>
    
    <meta name="theme-color" content="#2563eb">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --text: #1e293b;
            --manha: #dbeafe;
            --manha-txt: #1e40af;
            --tarde: #ffedd5;
            --tarde-txt: #9a3412;
            --noite: #4c1d95;
            --noite-txt: #ffffff;
            --zebra: #f8fafc;
        }

        * { box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: calc(env(safe-area-inset-top) + 10px) 10px 10px 10px; 
            overflow-x: hidden; 
        }

        .container { max-width: 100%; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .header-main { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 20px; 
            padding: 10px 0;
        }

        .header-main h1 { 
            font-size: 28px; 
            margin: 0; 
            color: var(--primary); 
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header-main .counter {
            font-size: 14px;
            color: #64748b;
            font-weight: bold;
            background: #f1f5f9;
            padding: 4px 15px;
            border-radius: 20px;
            margin-top: 8px;
        }

        .nav-wrapper { margin-bottom: 15px; position: sticky; top: 0; background: white; z-index: 10; padding: 5px 0; }
        .tabs { display: flex; gap: 4px; margin-bottom: 4px; overflow-x: auto; }
        .tabs-bottom { display: flex; justify-content: center; margin-top: 4px; }
        
        .tab-btn { flex: 1; min-width: 80px; padding: 12px 5px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 10px; color: #64748b; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn-large { max-width: 250px; background: #f1f5f9; border: 1px solid #e2e8f0; width: 100%; }

        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #1e293b; color: white; padding: 12px; font-size: 11px; text-align: center; }
        
        th:first-child { position: sticky; left: 0; z-index: 3; background: #1e293b; text-align: left; min-width: 200px; }
        
        td:first-child { 
            position: sticky; left: 0; z-index: 2; 
            text-align: left; 
            font-weight: bold; border-right: 2px solid #f1f5f9; 
            font-size: 17px;
            line-height: 1.3;
            padding: 12px 8px;
        }

        tbody tr:nth-child(even) td { background-color: var(--zebra); }
        tbody tr:nth-child(odd) td { background-color: #ffffff; }
        tbody tr:nth-child(even) td:first-child { background-color: var(--zebra); }
        tbody tr:nth-child(odd) td:first-child { background-color: #ffffff; }

        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 12px; text-align: center; }

        .status-badge { padding: 4px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; display: block; margin-bottom: 4px; }
        .status-pago { background: #dcfce7; color: #166534; }
        .status-aberto { background: #fef9c3; color: #854d0e; }

        .badge-turno { padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px; }
        .turno-manha { background: var(--manha); color: var(--manha-txt); }
        .turno-tarde { background: var(--tarde); color: var(--tarde-txt); }
        .turno-noite { background: var(--noite); color: var(--noite-txt); }

        input, select, textarea { width: 100%; padding: 14px; margin-top: 5px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: white; }
        textarea { height: 100px; font-family: sans-serif; font-size: 14px; resize: none; }
        
        .btn { padding: 8px 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; text-align: center; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-recibo { background: #6366f1; color: white; margin-top: 4px; width: 100%; display: block; }
        .btn-cobranca { background: var(--danger); color: white; margin-top: 4px; width: 100%; display: block; }
        .btn-ws { background: #25d366; color: white; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 5px; font-size: 16px; }

        .financeiro { margin-top: 15px; padding: 12px; background: #1e293b; border-radius: 10px; color: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .fin-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
        .fin-card h4 { margin: 0; font-size: 9px; color: #94a3b8; text-transform: uppercase; }
        .fin-card p { margin: 4px 0 0 0; font-size: 15px; font-weight: bold; }

        .hidden { display: none !important; }
        .info-sub { font-size: 13px; color: #475569; font-weight: 500; display: block; margin-top: 2px; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; font-weight: bold; }
        .checkbox-container input { width: auto; margin: 0; }

        .gasto-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .resumo-lucro { grid-column: span 2; background: #0f172a; border: 1px solid var(--primary); text-align: center; }

        /* Estilos da Carteirinha Escola */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 15px; }
        .carteirinha { width: 100%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 2px solid var(--primary); position: relative; }
        .carteirinha-header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .carteirinha-corpo { padding: 15px; display: grid; grid-template-columns: 1fr 100px; gap: 10px; }
        .carteirinha-info p { margin: 5px 0; font-size: 12px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .carteirinha-info strong { color: var(--primary); font-size: 10px; text-transform: uppercase; display: block; }
        .foto-aluno { width: 100px; height: 120px; border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background: #f8fafc; position: relative; }
        .foto-aluno img { width: 100%; height: 100%; object-fit: cover; }
        .btn-foto { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; border: none; font-size: 10px; padding: 5px; cursor: pointer; }
        .carteirinha-footer { padding: 15px; background: #f8fafc; display: flex; gap: 10px; }
        .observacoes-box { grid-column: span 2; background: #fffde7; padding: 8px; border-radius: 6px; font-size: 11px; font-style: italic; border: 1px solid #fef08a; }
    </style>
</head>
<body>

<div class="container">
    <header class="header-main">
        <h1>Transporte Pro</h1>
        <div id="totalPassageiros" class="counter">Total: 0 passageiros</div>
    </header>

    <nav class="nav-wrapper">
        <div class="tabs">
            <button class="tab-btn active" id="btn-painel" onclick="showTab('painel')">Pagamentos</button>
            <button class="tab-btn" id="btn-detalhes" onclick="showTab('detalhes')">Alunos</button>
            <button class="tab-btn" id="btn-cadastro" onclick="showTab('cadastro')">Novo</button>
            <button class="tab-btn" id="btn-config" onclick="showTab('config')">Config</button>
        </div>
        <div class="tabs-bottom">
            <button class="tab-btn tab-btn-large" id="btn-fluxo" onclick="showTab('fluxo')">üìä Fluxo e Gastos da Van</button>
        </div>
    </nav>

    <section id="painel">
        <input type="text" id="buscaNome" placeholder="üîç Buscar aluno..." onkeyup="renderPainel()">
        <div class="table-container">
            <table>
                <thead><tr id="headerMeses"></tr></thead>
                <tbody id="corpoPainel"></tbody>
            </table>
        </div>
        <div class="financeiro">
            <div class="fin-card"><h4>Recebido (<span id="txtMesAtivo">---</span>)</h4><p id="mRecebido" style="color:var(--success)">R$ 0,00</p></div>
            <div class="fin-card"><h4>Pendente (<span id="txtMesAtivo2">---</span>)</h4><p id="mReceber" style="color:var(--warning)">R$ 0,00</p></div>
        </div>
    </section>

    <section id="fluxo" class="hidden">
        <h3>Lan√ßar Gasto R√°pido</h3>
        <form id="formGasto">
            <input type="text" id="gastoDesc" placeholder="Descri√ß√£o (ex: Diesel)" required>
            <input type="number" step="0.01" id="gastoValor" placeholder="Valor R$" required>
            <button type="submit" class="btn btn-primary" style="background:var(--danger); padding: 15px; font-size: 14px;">LAN√áAR DESPESA AGORA</button>
        </form>
        <hr>
        <div id="filtroContainer" class="container" style="background:#f1f5f9; margin-bottom:15px; padding:10px;">
            <label style="font-size:12px; font-weight:bold;">Filtrar Per√≠odo:</label>
            <select id="filtroMesFluxo" onchange="renderFluxo()"></select>
        </div>
        <div class="financeiro">
            <div class="fin-card"><h4>Recebido</h4><p id="fluxoRecebido" style="color:var(--success)">R$ 0,00</p></div>
            <div class="fin-card"><h4>Gastos</h4><p id="fluxoGastos" style="color:var(--danger)">R$ 0,00</p></div>
            <div class="fin-card resumo-lucro"><h4>Lucro Real do Per√≠odo</h4><p id="fluxoLucro" style="font-size: 22px;">R$ 0,00</p></div>
        </div>
        <div id="listaGastos" style="margin-top: 15px;"></div>
    </section>

    <section id="detalhes" class="hidden">
        <input type="text" id="buscaAlunoTab" placeholder="üîç Buscar aluno..." onkeyup="renderDetalhes()">
        <div class="table-container" style="min-width: 100%;">
            <table style="min-width: 100%;">
                <thead><tr><th>Aluno / Escola</th><th>A√ß√µes</th></tr></thead>
                <tbody id="corpoDetalhes"></tbody>
            </table>
        </div>
    </section>

    <section id="cadastro" class="hidden">
        <form id="formCadastro">
            <input type="hidden" id="editId">
            <input type="text" id="nome" placeholder="Nome do Aluno" required>
            <input type="text" id="responsavel" placeholder="Respons√°vel">
            <input type="text" id="escola" placeholder="Escola">
            <select id="turno">
                <option value="Manh√£">Manh√£</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
            </select>
            <input type="number" step="0.01" id="valor" placeholder="Mensalidade R$" required>
            <input type="number" id="vencimento" placeholder="Dia Vencimento" required>
            <input type="text" id="telefone" placeholder="Telefone" oninput="maskTel(this)">
            
            <input type="text" id="endereco" placeholder="Endere√ßo Completo">
            <input type="text" id="bairro" placeholder="Bairro">
            <textarea id="observacoes" placeholder="Observa√ß√µes (opcional)"></textarea>

            <div class="checkbox-container">
                <input type="checkbox" id="enviarBoasVindas">
                <label for="enviarBoasVindas">Enviar boas-vindas WhatsApp</label>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 15px; font-size: 14px;">SALVAR CADASTRO</button>
            <button type="button" class="btn" style="width:100%; margin-top:10px; background:#94a3b8; color:white;" onclick="showTab('painel')">CANCELAR</button>
        </form>
    </section>

    <section id="config" class="hidden">
        <h3>Configura√ß√µes de Mensagens</h3>
        <label class="config-label">Recibo (Confirma√ß√£o)</label>
        <textarea id="msgRecibo"></textarea>
        <label class="config-label">Cobran√ßa (Aviso)</label>
        <textarea id="msgCobranca"></textarea>
        <label class="config-label">Boas-Vindas (Novo Aluno)</label>
        <textarea id="msgBoasVindas"></textarea>
        <button class="btn btn-primary" onclick="salvarConfig()" style="padding: 15px; font-size: 14px;">SALVAR CONFIGURA√á√ïES</button>
        <hr>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="exportarJSON()" style="background:#64748b">Fazer Backup Geral</button>
            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="background:#94a3b8">Importar Backup</button>
            <input type="file" id="importFile" style="display:none" onchange="importarJSON(event)">
        </div>
    </section>
</div>

<div id="modalFicha" class="modal-overlay hidden">
    <div class="carteirinha">
        <div class="carteirinha-header">Ficha Individual do Aluno</div>
        <div class="carteirinha-corpo">
            <div class="carteirinha-info" id="infoFicha"></div>
            <div class="foto-aluno">
                <img id="imgFicha" src="" class="hidden">
                <span id="fotoPlaceholder" style="font-size:10px; color:#94a3b8; text-align:center;">SEM FOTO</span>
                <input type="file" id="inputFoto" accept="image/*" capture="camera" style="display:none" onchange="processarFoto(event)">
                <button class="btn-foto" onclick="document.getElementById('inputFoto').click()">FOTO/C√ÇMERA</button>
            </div>
            <div class="observacoes-box" id="obsFicha"></div>
        </div>
        <div class="carteirinha-footer">
            <button class="btn btn-primary" id="btnEditarFicha">EDITAR DADOS</button>
            <button class="btn" style="background:#64748b; color:white; flex:1;" onclick="fecharFicha()">FECHAR</button>
        </div>
    </div>
</div>

<script>
    let passageiros = JSON.parse(localStorage.getItem('van_dados_v1')) || [];
    let gastos = JSON.parse(localStorage.getItem('van_gastos_v1')) || [];
    const meses = ["Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    
    let configMsg = localStorage.getItem('van_msg_recibo') || "‚úÖ *RECIBO DE PAGAMENTO*\n\nOl√°! Confirmamos o recebimento da mensalidade de *{nome}* referente ao m√™s de *{mes}*.\n\nüí∞ *Valor:* R$ {valor}\nüôè Obrigado pela confian√ßa!";
    let configCobranca = localStorage.getItem('van_msg_cobranca') || "‚ö†Ô∏è *AVISO DE VENCIMENTO*\n\nOl√°! Notamos que a mensalidade de *{nome}* ({mes}) ainda n√£o foi identificada no sistema.\n\nüíµ *Valor:* R$ {valor}\n\nCaso j√° tenha realizado o pagamento, favor desconsiderar ou enviar o comprovante. Obrigado!";
    let configBoasVindas = localStorage.getItem('van_msg_boasvindas') || "üöê *BEM-VINDO(A) AO TRANSPORTE PRO!*\n\nOl√°, o cadastro de *{nome}* foi conclu√≠do com sucesso.\n\nüìå *Detalhes:*\n- Vencimento: Todo dia {vencimento}\n- Mensalidade: R$ {valor}\n\nEstamos √† disposi√ß√£o para qualquer d√∫vida!";

    let idAlunoAtivo = null;

    function showTab(tabId) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
        if(tabId === 'painel') renderPainel();
        if(tabId === 'detalhes') renderDetalhes();
        if(tabId === 'fluxo') { preencherFiltroMes(); renderFluxo(); }
        if(tabId === 'config') preencherCamposConfig();
    }

    function preencherCamposConfig() {
        document.getElementById('msgRecibo').value = configMsg;
        document.getElementById('msgCobranca').value = configCobranca;
        document.getElementById('msgBoasVindas').value = configBoasVindas;
    }

    function renderPainel() {
        const hMeses = document.getElementById('headerMeses');
        const corpo = document.getElementById('corpoPainel');
        const busca = document.getElementById('buscaNome').value.toLowerCase();
        const dataHoje = new Date();
        const diaHoje = dataHoje.getDate();
        const mesAtualReal = dataHoje.getMonth();
        const anoAtual = dataHoje.getFullYear();
        let mesParaSoma = "Fev";

        if (mesAtualReal >= 1) {
            const nomeMes = dataHoje.toLocaleString('pt-br', { month: 'short' }).replace('.', '');
            mesParaSoma = nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1);
        }

        hMeses.innerHTML = '<th>Passageiro / Respons√°vel</th>';
        meses.forEach((m) => { 
            const isAtual = (m.toLowerCase() === mesParaSoma.toLowerCase() && mesAtualReal > 0);
            hMeses.innerHTML += `<th style="${isAtual ? 'background:var(--primary)' : ''}">${m}</th>`; 
        });

        corpo.innerHTML = '';
        let totalRec = 0; let totalPend = 0;

        passageiros.forEach(p => {
            if(busca && !p.nome.toLowerCase().includes(busca)) return;
            let rowHtml = `<td><div>${p.nome}</div><div class="info-sub">Resp: ${p.responsavel || '---'}</div><div style="display: flex; align-items: center; justify-content: space-between; margin-top:6px;"><span class="badge-turno ${getTurnoClass(p.turno)}">${p.turno}</span><a class="btn-ws" onclick="abrirZap('${p.telefone}')">üí¨</a></div></td>`;

            meses.forEach((m) => {
                const chaveAno = `${m}_${anoAtual}`;
                const isPago = p.pagamentos && p.pagamentos[chaveAno];
                const diaVenc = parseInt(p.vencimento);
                const valorNum = parseFloat(p.valor) || 0;
                const isMesCol = (m.toLowerCase() === mesParaSoma.toLowerCase());
                let deveCobrar = false;
                const idxCol = meses.indexOf(m);
                const idxAtu = meses.indexOf(mesParaSoma);

                if (!isPago && mesAtualReal > 0) {
                    if (idxCol < idxAtu) deveCobrar = true;
                    else if (isMesCol && diaHoje >= diaVenc) deveCobrar = true;
                }
                if(isMesCol && mesAtualReal > 0) { 
                    if(isPago) totalRec += valorNum; else totalPend += valorNum; 
                }
                rowHtml += `<td><span class="status-badge ${isPago ? 'status-pago' : 'status-aberto'}">${isPago ? 'PAGO' : 'ABERTO'}</span><button class="btn" style="background:#f8fafc; border:1px solid #cbd5e1" onclick="togglePagamento(${p.id}, '${m}', ${anoAtual})">Alt</button>${isPago ? `<button class="btn btn-recibo" onclick="enviarRecibo(${p.id}, '${m}')">üìÑ Recibo</button>` : (deveCobrar ? `<button class="btn btn-cobranca" onclick="enviarCobranca(${p.id}, '${m}')">üîî Cobrar</button>` : '')}</td>`;
            });
            const tr = document.createElement('tr'); tr.innerHTML = rowHtml; corpo.appendChild(tr);
        });

        const rotulo = (mesAtualReal === 0) ? "Jan (Off)" : mesParaSoma;
        document.getElementById('txtMesAtivo').innerText = rotulo;
        document.getElementById('txtMesAtivo2').innerText = rotulo;
        document.getElementById('mRecebido').innerText = `R$ ${totalRec.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        document.getElementById('mReceber').innerText = `R$ ${totalPend.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        atualizarContador();
    }

    function abrirFicha(id) {
        idAlunoAtivo = id;
        const p = passageiros.find(x => x.id == id);
        const info = document.getElementById('infoFicha');
        const obs = document.getElementById('obsFicha');
        info.innerHTML = `
            <p><strong>Nome Completo</strong>${p.nome}</p>
            <p><strong>Respons√°vel</strong>${p.responsavel || '-'}</p>
            <p><strong>Escola / Turno</strong>${p.escola} (${p.turno})</p>
            <p><strong>Telefone</strong>${p.telefone}</p>
            <p><strong>Endere√ßo</strong>${p.endereco || 'N√£o informado'}</p>
            <p><strong>Bairro</strong>${p.bairro || 'N√£o informado'}</p>
            <p><strong>Mensalidade</strong>R$ ${parseFloat(p.valor).toFixed(2)} (Dia ${p.vencimento})</p>
        `;
        obs.innerText = p.observacoes ? `Observa√ß√µes: ${p.observacoes}` : "Sem observa√ß√µes adicionais.";
        const img = document.getElementById('imgFicha');
        const placeholder = document.getElementById('fotoPlaceholder');
        if(p.foto) { img.src = p.foto; img.classList.remove('hidden'); placeholder.classList.add('hidden'); }
        else { img.classList.add('hidden'); placeholder.classList.remove('hidden'); }
        document.getElementById('btnEditarFicha').onclick = () => { fecharFicha(); editar(p.id); };
        document.getElementById('modalFicha').classList.remove('hidden');
    }

    function fecharFicha() { document.getElementById('modalFicha').classList.add('hidden'); idAlunoAtivo = null; }

    function processarFoto(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const pIndex = passageiros.findIndex(x => x.id == idAlunoAtivo);
                passageiros[pIndex].foto = base64;
                localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
                document.getElementById('imgFicha').src = base64;
                document.getElementById('imgFicha').classList.remove('hidden');
                document.getElementById('fotoPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function togglePagamento(id, mes, ano) {
        const p = passageiros.find(x => x.id == id);
        if(!p.pagamentos) p.pagamentos = {};
        const chave = `${mes}_${ano}`;
        p.pagamentos[chave] = !p.pagamentos[chave];
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
        renderPainel();
    }

    document.getElementById('formCadastro').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const idNum = id ? parseInt(id) : Date.now();
        const pExistente = id ? passageiros.find(x => x.id == id) : null;

        const p = { 
            id: idNum, 
            nome: document.getElementById('nome').value, 
            responsavel: document.getElementById('responsavel').value,
            escola: document.getElementById('escola').value,
            turno: document.getElementById('turno').value, 
            valor: parseFloat(document.getElementById('valor').value), 
            vencimento: parseInt(document.getElementById('vencimento').value), 
            telefone: document.getElementById('telefone').value, 
            endereco: document.getElementById('endereco').value,
            bairro: document.getElementById('bairro').value,
            observacoes: document.getElementById('observacoes').value,
            foto: pExistente ? pExistente.foto : null,
            pagamentos: pExistente ? (pExistente.pagamentos || {}) : {} 
        };

        if(id) passageiros[passageiros.findIndex(x => x.id == id)] = p;
        else passageiros.push(p);
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));

        if(document.getElementById('enviarBoasVindas').checked) {
            const v = p.valor.toLocaleString('pt-br',{minimumFractionDigits:2});
            let t = configBoasVindas.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{vencimento}/g, p.vencimento).replace(/{valor}/g, v);
            window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(t)}`, '_blank');
        }
        e.target.reset(); document.getElementById('editId').value = '';
        showTab('detalhes');
    });

    function renderDetalhes() {
        const corpo = document.getElementById('corpoDetalhes');
        const busca = document.getElementById('buscaAlunoTab').value.toLowerCase();
        corpo.innerHTML = '';
        passageiros.forEach(p => {
            if(busca && !p.nome.toLowerCase().includes(busca)) return;
            corpo.innerHTML += `<tr><td><strong>${p.nome}</strong><br><small>${p.escola} (${p.turno})</small></td><td>
                <button class="btn" style="background:var(--primary); color:white" onclick="abrirFicha(${p.id})">FICHA</button> 
                <button class="btn" style="background:var(--danger);color:white" onclick="excluir(${p.id})">üóëÔ∏è</button>
            </td></tr>`;
        });
    }

    function editar(id) {
        const p = passageiros.find(x => x.id == id);
        document.getElementById('editId').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('responsavel').value = p.responsavel;
        document.getElementById('escola').value = p.escola;
        document.getElementById('turno').value = p.turno;
        document.getElementById('valor').value = p.valor;
        document.getElementById('vencimento').value = p.vencimento;
        document.getElementById('telefone').value = p.telefone;
        document.getElementById('endereco').value = p.endereco || '';
        document.getElementById('bairro').value = p.bairro || '';
        document.getElementById('observacoes').value = p.observacoes || '';
        showTab('cadastro');
    }

    function preencherFiltroMes() {
        const seletor = document.getElementById('filtroMesFluxo');
        if(seletor.options.length > 0) return;
        const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const anoAt = new Date().getFullYear();
        [anoAt - 1, anoAt].forEach(ano => {
            nomesMeses.forEach((nome, index) => {
                const opt = document.createElement('option');
                opt.value = `${index}-${ano}`; opt.text = `${nome} / ${ano}`;
                if(ano === anoAt && index === new Date().getMonth()) opt.selected = true;
                seletor.appendChild(opt);
            });
        });
    }

    document.getElementById('formGasto').addEventListener('submit', (e) => {
        e.preventDefault();
        const novoGasto = { id: Date.now(), desc: document.getElementById('gastoDesc').value, valor: parseFloat(document.getElementById('gastoValor').value), data: new Date().toISOString().split('T')[0] };
        gastos.push(novoGasto);
        localStorage.setItem('van_gastos_v1', JSON.stringify(gastos));
        e.target.reset(); renderFluxo();
    });

    function renderFluxo() {
        const lista = document.getElementById('listaGastos');
        const filtro = document.getElementById('filtroMesFluxo').value.split('-');
        const mesAlvo = parseInt(filtro[0]); const anoAlvo = parseInt(filtro[1]);
        const nomesAbrev = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const mesChave = nomesAbrev[mesAlvo];
        let totalRecebido = 0;
        passageiros.forEach(p => { const chave = `${mesChave}_${anoAlvo}`; if(p.pagamentos && p.pagamentos[chave]) totalRecebido += parseFloat(p.valor || 0); });
        let totalGastos = 0;
        lista.innerHTML = `<h4 style="font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">Gastos em ${mesChave}/${anoAlvo}</h4>`;
        gastos.filter(g => { const d = new Date(g.data + 'T00:00:00'); return d.getMonth() === mesAlvo && d.getFullYear() === anoAlvo; }).forEach(g => {
            totalGastos += g.valor;
            lista.innerHTML += `<div class="gasto-item"><span><strong>${g.desc}</strong></span><span>R$ ${g.valor.toLocaleString('pt-br',{minimumFractionDigits:2})} <button onclick="removerGasto(${g.id})" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">X</button></span></div>`;
        });
        document.getElementById('fluxoRecebido').innerText = `R$ ${totalRecebido.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        document.getElementById('fluxoGastos').innerText = `R$ ${totalGastos.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        const lucro = totalRecebido - totalGastos;
        document.getElementById('fluxoLucro').innerText = `R$ ${lucro.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        document.getElementById('fluxoLucro').style.color = lucro >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    function removerGasto(id) { if(confirm("Excluir este gasto?")) { gastos = gastos.filter(g => g.id !== id); localStorage.setItem('van_gastos_v1', JSON.stringify(gastos)); renderFluxo(); } }
    function maskTel(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }
    function getTurnoClass(t) { return t === 'Manh√£' ? 'turno-manha' : t === 'Tarde' ? 'turno-tarde' : 'turno-noite'; }
    function atualizarContador() { document.getElementById('totalPassageiros').innerText = `Total: ${passageiros.length} passageiros`; }
    function abrirZap(t) { window.open(`https://wa.me/55${t.replace(/\D/g,'')}`, '_blank'); }
    function enviarRecibo(id, mes) {
        const p = passageiros.find(x => x.id == id);
        const v = parseFloat(p.valor).toLocaleString('pt-br',{minimumFractionDigits:2});
        let t = configMsg.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{mes}/g, mes.toUpperCase()).replace(/{valor}/g, v);
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(t)}`, '_blank');
    }
    function enviarCobranca(id, mes) {
        const p = passageiros.find(x => x.id == id);
        const v = parseFloat(p.valor).toLocaleString('pt-br',{minimumFractionDigits:2});
        let t = configCobranca.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{mes}/g, mes.toUpperCase()).replace(/{valor}/g, v);
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(t)}`, '_blank');
    }
    function excluir(id) { if(confirm("Excluir cadastro permanentemente?")) { passageiros = passageiros.filter(x => x.id != id); localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); renderDetalhes(); } }
    
    function salvarConfig() {
        configMsg = document.getElementById('msgRecibo').value;
        configCobranca = document.getElementById('msgCobranca').value;
        configBoasVindas = document.getElementById('msgBoasVindas').value;
        localStorage.setItem('van_msg_recibo', configMsg);
        localStorage.setItem('van_msg_cobranca', configCobranca);
        localStorage.setItem('van_msg_boasvindas', configBoasVindas);
        alert("Configura√ß√µes salvas!");
    }

    function exportarJSON() { 
        const dados = {
            passageiros: passageiros,
            gastos: gastos,
            config: { recibo: configMsg, cobranca: configCobranca, boasVindas: configBoasVindas },
            versao: "1.2",
            data: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(dados)], {type: 'application/json'}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_van_pro_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`; a.click(); 
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function importarJSON(e) { 
        const reader = new FileReader(); 
        reader.onload = (ev) => { 
            try {
                const d = JSON.parse(ev.target.result); 
                passageiros = (d.passageiros || d.p || []).map(p => ({
                    ...p, endereco: p.endereco || "", bairro: p.bairro || "", observacoes: p.observacoes || "", foto: p.foto || null
                })); 
                gastos = d.gastos || d.g || [];
                if(d.config) {
                    configMsg = d.config.recibo || configMsg; configCobranca = d.config.cobranca || configCobranca; configBoasVindas = d.config.boasVindas || configBoasVindas;
                    localStorage.setItem('van_msg_recibo', configMsg); localStorage.setItem('van_msg_cobranca', configCobranca); localStorage.setItem('van_msg_boasvindas', configBoasVindas);
                }
                localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); localStorage.setItem('van_gastos_v1', JSON.stringify(gastos)); 
                alert("Backup restaurado com sucesso!"); location.reload(); 
            } catch (err) { alert("Erro ao importar arquivo!"); }
        }; 
        reader.readAsText(e.target.files[0]); 
    }

    window.onload = () => { renderPainel(); atualizarContador(); };
</script>
</body>
</html>
