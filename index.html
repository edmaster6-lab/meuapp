<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transporte Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    
    <link rel="manifest" href="data:application/manifest+json,{'name':'Transporte Pro','short_name':'TranspPro','start_url':'.','display':'standalone','background_color':'#f1f5f9','theme_color':'#2563eb','icons':[{'src':'https://cdn-icons-png.flaticon.com/512/713/713311.png','sizes':'512x512','type':'image/png'}]}">

    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --text: #1e293b;
        }

        * { box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; }

        .container { max-width: 100%; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-main { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .header-main h1 { font-size: 18px; margin: 0; color: var(--primary); }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; position: sticky; top: 0; background: white; z-index: 10; padding: 5px 0; }
        .tab-btn { flex: 1; padding: 12px 5px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 11px; color: #64748b; }
        .tab-btn.active { background: var(--primary); color: white; }

        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #1e293b; color: white; padding: 12px; font-size: 11px; text-align: center; position: sticky; top: 0; }
        th:first-child { position: sticky; left: 0; z-index: 3; background: #1e293b; text-align: left; min-width: 140px; }
        td:first-child { position: sticky; left: 0; z-index: 2; background: white; text-align: left; font-weight: bold; border-right: 2px solid #f1f5f9; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 12px; text-align: center; }

        .status-badge { padding: 4px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; display: block; margin-bottom: 4px; }
        .status-pago { background: #dcfce7; color: #166534; }
        .status-aberto { background: #fef9c3; color: #854d0e; }

        input, select { width: 100%; padding: 14px; margin-top: 5px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: white; }
        
        .btn { padding: 8px 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; text-align: center; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-recibo { background: #6366f1; color: white; margin-top: 4px; width: 100%; display: block; }
        .btn-ws { background: #25d366; color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 5px; font-size: 14px; }

        .financeiro { margin-top: 15px; padding: 12px; background: #1e293b; border-radius: 10px; color: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .fin-card h4 { margin: 0; font-size: 9px; color: #94a3b8; text-transform: uppercase; }
        .fin-card p { margin: 4px 0 0 0; font-size: 15px; font-weight: bold; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header class="header-main">
        <span>üöå</span>
        <h1>Transporte Pro <small style="font-size: 9px; opacity: 0.7;">Offline v1.3.5</small></h1>
    </header>

    <nav class="tabs">
        <button class="tab-btn active" id="btn-painel" onclick="showTab('painel')">PAGAMENTOS</button>
        <button class="tab-btn" id="btn-detalhes" onclick="showTab('detalhes')">ALUNOS</button>
        <button class="tab-btn" id="btn-cadastro" onclick="showTab('cadastro')">+ NOVO</button>
    </nav>

    <section id="painel">
        <input type="text" id="buscaNome" placeholder="üîç Buscar aluno..." onkeyup="renderPainel()">
        <div class="table-container">
            <table>
                <thead><tr id="headerMeses"></tr></thead>
                <tbody id="corpoPainel"></tbody>
            </table>
        </div>
        <div class="financeiro">
            <div class="fin-card"><h4>Recebido (<span id="txtMesAtivo">...</span>)</h4><p id="mRecebido" style="color:var(--success)">R$ 0,00</p></div>
            <div class="fin-card"><h4>Pendente (<span id="txtMesAtivo2">...</span>)</h4><p id="mReceber" style="color:var(--warning)">R$ 0,00</p></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="exportarJSON()" style="background:#64748b">Backup</button>
            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="background:#94a3b8">Importar</button>
            <input type="file" id="importFile" style="display:none" onchange="importarJSON(event)">
        </div>
    </section>

    <section id="detalhes" class="hidden">
        <div class="table-container" style="min-width: 100%;">
            <table style="min-width: 100%;">
                <thead><tr><th>Aluno / Turno</th><th>A√ß√µes</th></tr></thead>
                <tbody id="corpoDetalhes"></tbody>
            </table>
        </div>
    </section>

    <section id="cadastro" class="hidden">
        <form id="formCadastro">
            <input type="hidden" id="editId">
            <input type="text" id="nome" placeholder="Nome do Aluno" required>
            <select id="turno"><option value="Manh√£">Manh√£</option><option value="Tarde">Tarde</option><option value="Noite">Noite</option></select>
            <input type="number" step="0.01" id="valor" placeholder="Valor Mensalidade R$" required>
            <input type="number" id="vencimento" placeholder="Dia Vencimento (1-31)" required>
            <input type="text" id="responsavel" placeholder="Respons√°vel">
            <input type="text" id="telefone" placeholder="Telefone (DDD) 99999-9999" oninput="maskTel(this)">
            <button type="submit" class="btn btn-primary" style="padding:15px; font-size:14px">SALVAR DADOS</button>
        </form>
    </section>
</div>

<script>
    let passageiros = JSON.parse(localStorage.getItem('van_dados_v1')) || [];
    const meses = ["Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

    function maskTel(i) {
        let v = i.value.replace(/\D/g, "");
        v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
        v = v.replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
    }

    function showTab(tabId) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
        if(tabId === 'painel') renderPainel();
        if(tabId === 'detalhes') renderDetalhes();
    }

    function renderPainel() {
        const hMeses = document.getElementById('headerMeses');
        const corpo = document.getElementById('corpoPainel');
        const busca = document.getElementById('buscaNome').value.toLowerCase();
        
        const dataHoje = new Date();
        const mesRealIdx = dataHoje.getMonth();
        
        // Se for Janeiro (0), aponta para Fevereiro para exibir as somas de Fev nos cards.
        let mesAtualNome = (mesRealIdx === 0) ? "Fev" : meses[mesRealIdx - 1];

        document.getElementById('txtMesAtivo').innerText = mesAtualNome;
        document.getElementById('txtMesAtivo2').innerText = mesAtualNome;

        hMeses.innerHTML = '<th>Passageiro</th>';
        meses.forEach(m => { 
            hMeses.innerHTML += `<th style="${m === mesAtualNome ? 'background:var(--primary)' : ''}">${m}</th>`; 
        });

        corpo.innerHTML = '';
        let mRec = 0, mPend = 0;

        passageiros.forEach(p => {
            if(busca && !p.nome.toLowerCase().includes(busca)) return;
            let rowHtml = `<td>${p.nome}<br><a class="btn-ws" onclick="abrirZap('${p.telefone}')">üí¨</a></td>`;

            meses.forEach(m => {
                const isPago = p.pagamentos && p.pagamentos[m];
                
                if(m === mesAtualNome) { 
                    const valorNum = parseFloat(p.valor) || 0;
                    if(isPago) mRec += valorNum; 
                    else mPend += valorNum; 
                }

                rowHtml += `<td>
                    <span class="status-badge ${isPago ? 'status-pago' : 'status-aberto'}">${isPago ? 'PAGO' : 'ABERTO'}</span>
                    <button class="btn" style="background:#f8fafc; border:1px solid #cbd5e1" onclick="togglePagamento(${p.id}, '${m}')">Alt</button>
                    ${isPago ? `<button class="btn btn-recibo" onclick="enviarRecibo(${p.id}, '${m}')">üìÑ</button>` : ''}
                </td>`;
            });
            const tr = document.createElement('tr');
            tr.innerHTML = rowHtml;
            corpo.appendChild(tr);
        });

        document.getElementById('mRecebido').innerText = `R$ ${mRec.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        document.getElementById('mReceber').innerText = `R$ ${mPend.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
    }

    function togglePagamento(id, mes) {
        const p = passageiros.find(x => x.id == id);
        if(!p.pagamentos) p.pagamentos = {};
        p.pagamentos[mes] = !p.pagamentos[mes];
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
        renderPainel();
    }

    function enviarRecibo(id, mes) {
        const p = passageiros.find(x => x.id == id);
        const valorFormatado = parseFloat(p.valor).toLocaleString('pt-br', {minimumFractionDigits:2});
        
        // --- TEXTO COM EMOJIS UNIVERSAIS ---
        const texto = `*CONFIRMA√á√ÉO DE PAGAMENTO*%0A%0AOl√°, informamos que o seu pagamento foi processado com sucesso.%0A%0A*DADOS DO RECIBO:*%0A- *Passageiro:* ${p.nome.toUpperCase()}%0A- *M√™s:* ${mes.toUpperCase()}%0A- *Valor:* R$ ${valorFormatado}%0A- *Status:* PAGO ‚úÖ%0A%0AAgradecemos a prefer√™ncia!%0A----------------------------%0A*TRANSPORTE PRO*`;
        
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${texto}`, '_blank');
    }

    document.getElementById('formCadastro').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const p = { 
            id: id ? parseInt(id) : Date.now(), 
            nome: document.getElementById('nome').value, 
            turno: document.getElementById('turno').value, 
            valor: parseFloat(document.getElementById('valor').value), 
            vencimento: parseInt(document.getElementById('vencimento').value), 
            responsavel: document.getElementById('responsavel').value, 
            telefone: document.getElementById('telefone').value, 
            pagamentos: id ? (passageiros.find(x => x.id == id).pagamentos || {}) : {} 
        };
        if(id) passageiros[passageiros.findIndex(x => x.id == id)] = p;
        else passageiros.push(p);
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
        e.target.reset(); document.getElementById('editId').value = '';
        showTab('painel');
    });

    function renderDetalhes() {
        const corpo = document.getElementById('corpoDetalhes');
        corpo.innerHTML = '';
        passageiros.forEach(p => {
            corpo.innerHTML += `<tr><td><strong>${p.nome}</strong><br><small>${p.turno}</small></td><td><button class="btn" style="background:#e2e8f0" onclick="editar(${p.id})">‚úèÔ∏è</button><button class="btn" style="background:var(--danger);color:white" onclick="excluir(${p.id})">üóëÔ∏è</button></td></tr>`;
        });
    }

    function editar(id) {
        const p = passageiros.find(x => x.id == id);
        document.getElementById('editId').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('turno').value = p.turno;
        document.getElementById('valor').value = p.valor;
        document.getElementById('vencimento').value = p.vencimento;
        document.getElementById('responsavel').value = p.responsavel;
        document.getElementById('telefone').value = p.telefone;
        showTab('cadastro');
    }

    function excluir(id) { if(confirm("Remover aluno?")) { passageiros = passageiros.filter(x => x.id != id); localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); renderDetalhes(); } }
    function abrirZap(t) { window.open(`https://wa.me/55${t.replace(/\D/g,'')}`, '_blank'); }
    function exportarJSON() { const blob = new Blob([JSON.stringify(passageiros)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_transporte.json`; a.click(); }
    function importarJSON(e) { const reader = new FileReader(); reader.onload = (ev) => { try { passageiros = JSON.parse(ev.target.result); localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); renderPainel(); } catch(err) { alert("Arquivo inv√°lido"); } }; reader.readAsText(e.target.files[0]); }
    
    window.onload = renderPainel;
</script>
</body>
</html>
