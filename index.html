<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Transporte Pro">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <title>Transporte Pro</title>
    
    <meta name="theme-color" content="#2563eb">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --text: #1e293b;
            --manha: #dbeafe;
            --manha-txt: #1e40af;
            --tarde: #ffedd5;
            --tarde-txt: #9a3412;
            --noite: #4c1d95;
            --noite-txt: #ffffff;
            --zebra: #f8fafc;
        }

        * { box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: calc(env(safe-area-inset-top) + 10px) 10px 10px 10px; 
            overflow-x: hidden; 
        }

        .container { max-width: 100%; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .header-main { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 20px; 
            padding: 10px 0;
        }

        .header-main h1 { 
            font-size: 28px; 
            margin: 0; 
            color: var(--primary); 
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header-main .counter {
            font-size: 14px;
            color: #64748b;
            font-weight: bold;
            background: #f1f5f9;
            padding: 4px 15px;
            border-radius: 20px;
            margin-top: 8px;
        }

        .tabs { display: flex; gap: 4px; margin-bottom: 15px; position: sticky; top: 0; background: white; z-index: 10; padding: 5px 0; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 80px; padding: 12px 5px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 10px; color: #64748b; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: white; }

        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #1e293b; color: white; padding: 12px; font-size: 11px; text-align: center; }
        
        th:first-child { position: sticky; left: 0; z-index: 3; background: #1e293b; text-align: left; min-width: 200px; }
        
        td:first-child { 
            position: sticky; left: 0; z-index: 2; 
            text-align: left; 
            font-weight: bold; border-right: 2px solid #f1f5f9; 
            font-size: 17px;
            line-height: 1.3;
            padding: 12px 8px;
        }

        tbody tr:nth-child(even) td { background-color: var(--zebra); }
        tbody tr:nth-child(odd) td { background-color: #ffffff; }
        tbody tr:nth-child(even) td:first-child { background-color: var(--zebra); }
        tbody tr:nth-child(odd) td:first-child { background-color: #ffffff; }

        td { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 12px; text-align: center; }

        .status-badge { padding: 4px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; display: block; margin-bottom: 4px; }
        .status-pago { background: #dcfce7; color: #166534; }
        .status-aberto { background: #fef9c3; color: #854d0e; }

        .badge-turno { padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px; }
        .turno-manha { background: var(--manha); color: var(--manha-txt); }
        .turno-tarde { background: var(--tarde); color: var(--tarde-txt); }
        .turno-noite { background: var(--noite); color: var(--noite-txt); }

        input, select, textarea { width: 100%; padding: 14px; margin-top: 5px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: white; }
        textarea { height: 100px; font-family: monospace; font-size: 14px; resize: none; }
        
        .btn { padding: 8px 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; text-align: center; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-recibo { background: #6366f1; color: white; margin-top: 4px; width: 100%; display: block; }
        .btn-cobranca { background: var(--danger); color: white; margin-top: 4px; width: 100%; display: block; }
        .btn-ws { background: #25d366; color: white; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 5px; font-size: 16px; }

        .financeiro { margin-top: 15px; padding: 12px; background: #1e293b; border-radius: 10px; color: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .fin-card h4 { margin: 0; font-size: 9px; color: #94a3b8; text-transform: uppercase; }
        .fin-card p { margin: 4px 0 0 0; font-size: 15px; font-weight: bold; }

        .config-label { font-weight: bold; font-size: 13px; display: block; margin-top: 10px; color: var(--primary); }
        .hidden { display: none !important; }
        .info-sub { font-size: 13px; color: #475569; font-weight: 500; display: block; margin-top: 2px; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; font-weight: bold; }
        .checkbox-container input { width: auto; margin: 0; }
        .nome-destaque { font-size: 18px; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="container">
    <header class="header-main">
        <h1>Transporte Pro</h1>
        <div id="totalPassageiros" class="counter">Total: 0 passageiros</div>
    </header>

    <nav class="tabs">
        <button class="tab-btn active" id="btn-painel" onclick="showTab('painel')">Pagamentos</button>
        <button class="tab-btn" id="btn-detalhes" onclick="showTab('detalhes')">Alunos</button>
        <button class="tab-btn" id="btn-cadastro" onclick="showTab('cadastro')">Novo</button>
        <button class="tab-btn" id="btn-config" onclick="showTab('config')">Config</button>
    </nav>

    <section id="painel">
        <input type="text" id="buscaNome" placeholder="üîç Buscar aluno, escola ou respons√°vel..." onkeyup="renderPainel()">
        <div class="table-container">
            <table>
                <thead><tr id="headerMeses"></tr></thead>
                <tbody id="corpoPainel"></tbody>
            </table>
        </div>
        <div class="financeiro">
            <div class="fin-card"><h4>Recebido (<span id="txtMesAtivo">...</span>)</h4><p id="mRecebido" style="color:var(--success)">R$ 0,00</p></div>
            <div class="fin-card"><h4>Pendente (<span id="txtMesAtivo2">...</span>)</h4><p id="mReceber" style="color:var(--warning)">R$ 0,00</p></div>
        </div>
    </section>

    <section id="detalhes" class="hidden">
        <input type="text" id="buscaAlunoTab" placeholder="üîç Buscar aluno ou escola..." onkeyup="renderDetalhes()">
        <div class="table-container" style="min-width: 100%;">
            <table style="min-width: 100%;">
                <thead><tr><th>Aluno / Escola / Turno</th><th>A√ß√µes</th></tr></thead>
                <tbody id="corpoDetalhes"></tbody>
            </table>
        </div>
    </section>

    <section id="cadastro" class="hidden">
        <form id="formCadastro">
            <input type="hidden" id="editId">
            <input type="text" id="nome" placeholder="Nome do Aluno" required>
            <input type="text" id="responsavel" placeholder="Nome do Pai ou Respons√°vel">
            <input type="text" id="escola" placeholder="Nome da Escola">
            <select id="turno">
                <option value="Manh√£">Manh√£</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
            </select>
            <input type="number" step="0.01" id="valor" placeholder="Valor Mensalidade R$" required>
            <input type="number" id="vencimento" placeholder="Dia Vencimento (1-31)" required>
            <input type="text" id="telefone" placeholder="Telefone (DDD) 99999-9999" oninput="maskTel(this)">
            <div class="checkbox-container">
                <input type="checkbox" id="enviarBoasVindas">
                <label for="enviarBoasVindas">Enviar boas-vindas ao salvar</label>
            </div>
            <button type="submit" class="btn btn-primary" style="padding:15px; font-size:14px">SALVAR DADOS</button>
        </form>
    </section>

    <section id="config" class="hidden">
        <h3>Configura√ß√µes</h3>
        <label class="config-label">Mensagem de Recibo</label><textarea id="msgRecibo"></textarea>
        <label class="config-label">Mensagem de Cobran√ßa</label><textarea id="msgCobranca"></textarea>
        <label class="config-label">Mensagem de Boas-Vindas</label><textarea id="msgBoasVindas"></textarea>
        <button class="btn btn-primary" onclick="salvarConfig()" style="padding:15px; margin-bottom: 20px;">SALVAR CONFIGURA√á√ïES</button>
        <hr>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="exportarJSON()" style="background:#64748b">Backup</button>
            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="background:#94a3b8">Restaurar</button>
            <input type="file" id="importFile" style="display:none" onchange="importarJSON(event)">
        </div>
    </section>
</div>

<script>
    let passageiros = JSON.parse(localStorage.getItem('van_dados_v1')) || [];
    const meses = ["Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    
    const msgPadraoRecibo = "*CONFIRMA√á√ÉO DE PAGAMENTO*\n\nOl√°, seu pagamento foi processado.\n- *Passageiro:* {nome}\n- *M√™s:* {mes}\n- *Valor:* R$ {valor}\n- *Status:* PAGO ‚úÖ";
    const msgPadraoCobranca = "*AVISO DE VENCIMENTO*\n\nOl√°, o pagamento de {nome} ({mes}) ainda n√£o consta no sistema.\n- *Valor:* R$ {valor}";
    const msgPadraoBoasVindas = "*BOAS-VINDAS!*\n\nOl√° {nome}, cadastro realizado com sucesso!\n- *Vencimento:* Dia {vencimento}\n- *Valor:* R$ {valor}";

    let configMsg = localStorage.getItem('van_msg_recibo') || msgPadraoRecibo;
    let configCobranca = localStorage.getItem('van_msg_cobranca') || msgPadraoCobranca;
    let configBoasVindas = localStorage.getItem('van_msg_boasvindas') || msgPadraoBoasVindas;

    function atualizarContador() {
        document.getElementById('totalPassageiros').innerText = `Total: ${passageiros.length} passageiro${passageiros.length !== 1 ? 's' : ''}`;
    }

    function getTurnoClass(turno) {
        if(turno === 'Manh√£') return 'turno-manha';
        if(turno === 'Tarde') return 'turno-tarde';
        if(turno === 'Noite') return 'turno-noite';
        return '';
    }

    function maskTel(i) {
        let v = i.value.replace(/\D/g, "");
        v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
        v = v.replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
    }

    function showTab(tabId) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
        if(tabId === 'painel') renderPainel();
        if(tabId === 'detalhes') renderDetalhes();
        if(tabId === 'config') {
            document.getElementById('msgRecibo').value = configMsg;
            document.getElementById('msgCobranca').value = configCobranca;
            document.getElementById('msgBoasVindas').value = configBoasVindas;
        }
        atualizarContador();
    }

    function salvarConfig() {
        configMsg = document.getElementById('msgRecibo').value;
        configCobranca = document.getElementById('msgCobranca').value;
        configBoasVindas = document.getElementById('msgBoasVindas').value;
        localStorage.setItem('van_msg_recibo', configMsg);
        localStorage.setItem('van_msg_cobranca', configCobranca);
        localStorage.setItem('van_msg_boasvindas', configBoasVindas);
        alert("Configura√ß√µes salvas!");
    }

    function renderPainel() {
        const hMeses = document.getElementById('headerMeses');
        const corpo = document.getElementById('corpoPainel');
        const busca = document.getElementById('buscaNome').value.toLowerCase();
        const dataHoje = new Date();
        const diaAtual = dataHoje.getDate();
        const mesRealIdx = dataHoje.getMonth();
        let mesAtualNome = (mesRealIdx === 0) ? "Fev" : meses[mesRealIdx - 1];

        document.getElementById('txtMesAtivo').innerText = mesAtualNome;
        document.getElementById('txtMesAtivo2').innerText = mesAtualNome;

        hMeses.innerHTML = '<th>Passageiro / Respons√°vel</th>';
        meses.forEach(m => { 
            hMeses.innerHTML += `<th style="${m === mesAtualNome ? 'background:var(--primary)' : ''}">${m}</th>`; 
        });

        corpo.innerHTML = '';
        let mRec = 0, mPend = 0;

        passageiros.forEach(p => {
            if(busca && !p.nome.toLowerCase().includes(busca) && !p.escola?.toLowerCase().includes(busca) && !p.responsavel?.toLowerCase().includes(busca)) return;
            
            let rowHtml = `<td>
                <div>${p.nome}</div>
                <div class="info-sub">Resp: ${p.responsavel || '---'}</div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top:6px;">
                    <span class="badge-turno ${getTurnoClass(p.turno)}">${p.turno}</span>
                    <a class="btn-ws" onclick="abrirZap('${p.telefone}')">üí¨</a>
                </div>
            </td>`;

            meses.forEach(m => {
                const isPago = p.pagamentos && p.pagamentos[m];
                const diaVencimento = parseInt(p.vencimento);
                
                // L√ìGICA RIGOROSA: 
                // 1. Deve estar em aberto (!isPago)
                // 2. O dia atual deve ser maior ou igual ao dia de vencimento
                const deveMostrarCobranca = !isPago && (diaAtual >= diaVencimento);

                if(m === mesAtualNome) { 
                    const valorNum = parseFloat(p.valor) || 0;
                    if(isPago) mRec += valorNum; else mPend += valorNum; 
                }

                rowHtml += `<td>
                    <span class="status-badge ${isPago ? 'status-pago' : 'status-aberto'}">${isPago ? 'PAGO' : 'ABERTO'}</span>
                    <button class="btn" style="background:#f8fafc; border:1px solid #cbd5e1" onclick="togglePagamento(${p.id}, '${m}')">Alt</button>
                    ${isPago ? 
                        `<button class="btn btn-recibo" onclick="enviarRecibo(${p.id}, '${m}')">üìÑ Recibo</button>` : 
                        (deveMostrarCobranca ? `<button class="btn btn-cobranca" onclick="enviarCobranca(${p.id}, '${m}')">üîî Cobrar</button>` : '')
                    }
                </td>`;
            });
            const tr = document.createElement('tr');
            tr.innerHTML = rowHtml;
            corpo.appendChild(tr);
        });

        document.getElementById('mRecebido').innerText = `R$ ${mRec.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        document.getElementById('mReceber').innerText = `R$ ${mPend.toLocaleString('pt-br',{minimumFractionDigits:2})}`;
        atualizarContador();
    }

    function togglePagamento(id, mes) {
        const p = passageiros.find(x => x.id == id);
        if(!p.pagamentos) p.pagamentos = {};
        p.pagamentos[mes] = !p.pagamentos[mes];
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
        renderPainel();
    }

    function enviarRecibo(id, mes) {
        const p = passageiros.find(x => x.id == id);
        const valorF = parseFloat(p.valor).toLocaleString('pt-br', {minimumFractionDigits:2});
        let textoFinal = configMsg.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{mes}/g, mes.toUpperCase()).replace(/{valor}/g, valorF);
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(textoFinal)}`, '_blank');
    }

    function enviarCobranca(id, mes) {
        const p = passageiros.find(x => x.id == id);
        const valorF = parseFloat(p.valor).toLocaleString('pt-br', {minimumFractionDigits:2});
        let textoFinal = configCobranca.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{mes}/g, mes.toUpperCase()).replace(/{valor}/g, valorF);
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(textoFinal)}`, '_blank');
    }

    function enviarBoasVindas(p) {
        const valorF = parseFloat(p.valor).toLocaleString('pt-br', {minimumFractionDigits:2});
        let textoFinal = configBoasVindas.replace(/{nome}/g, p.nome.toUpperCase()).replace(/{vencimento}/g, p.vencimento).replace(/{valor}/g, valorF);
        window.open(`https://wa.me/55${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(textoFinal)}`, '_blank');
    }

    document.getElementById('formCadastro').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const p = { 
            id: id ? parseInt(id) : Date.now(), 
            nome: document.getElementById('nome').value, 
            responsavel: document.getElementById('responsavel').value,
            escola: document.getElementById('escola').value,
            turno: document.getElementById('turno').value, 
            valor: parseFloat(document.getElementById('valor').value), 
            vencimento: parseInt(document.getElementById('vencimento').value), 
            telefone: document.getElementById('telefone').value, 
            pagamentos: id ? (passageiros.find(x => x.id == id).pagamentos || {}) : {} 
        };
        if(id) passageiros[passageiros.findIndex(x => x.id == id)] = p;
        else passageiros.push(p);
        localStorage.setItem('van_dados_v1', JSON.stringify(passageiros));
        if (document.getElementById('enviarBoasVindas').checked) { enviarBoasVindas(p); }
        e.target.reset(); document.getElementById('editId').value = '';
        showTab('painel');
    });

    function renderDetalhes() {
        const corpo = document.getElementById('corpoDetalhes');
        const busca = document.getElementById('buscaAlunoTab').value.toLowerCase();
        corpo.innerHTML = '';
        passageiros.forEach(p => {
            if(busca && !p.nome.toLowerCase().includes(busca) && !p.escola?.toLowerCase().includes(busca)) return;
            corpo.innerHTML += `<tr>
                <td>
                    <strong class="nome-destaque">${p.nome}</strong>
                    <small>${p.escola || '---'}</small> - 
                    <span class="badge-turno ${getTurnoClass(p.turno)}">${p.turno}</span>
                </td>
                <td>
                    <button class="btn" style="background:#e2e8f0" onclick="editar(${p.id})">‚úèÔ∏è</button>
                    <button class="btn" style="background:var(--danger);color:white" onclick="excluir(${p.id})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        atualizarContador();
    }

    function editar(id) {
        const p = passageiros.find(x => x.id == id);
        document.getElementById('editId').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('responsavel').value = p.responsavel || '';
        document.getElementById('escola').value = p.escola || '';
        document.getElementById('turno').value = p.turno;
        document.getElementById('valor').value = p.valor;
        document.getElementById('vencimento').value = p.vencimento;
        document.getElementById('telefone').value = p.telefone;
        document.getElementById('enviarBoasVindas').checked = false;
        showTab('cadastro');
    }

    function excluir(id) { if(confirm("Remover?")) { passageiros = passageiros.filter(x => x.id != id); localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); renderDetalhes(); } }
    function abrirZap(t) { window.open(`https://wa.me/55${t.replace(/\D/g,'')}`, '_blank'); }
    function exportarJSON() { const blob = new Blob([JSON.stringify(passageiros)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup.json`; a.click(); }
    function importarJSON(e) { const reader = new FileReader(); reader.onload = (ev) => { try { passageiros = JSON.parse(ev.target.result); localStorage.setItem('van_dados_v1', JSON.stringify(passageiros)); renderPainel(); } catch(err) { alert("Erro"); } }; reader.readAsText(e.target.files[0]); }
    
    window.onload = () => {
        renderPainel();
        atualizarContador();
    };
</script>
</body>
</html>
